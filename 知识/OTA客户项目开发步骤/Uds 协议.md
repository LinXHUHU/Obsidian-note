
# 1 前言
诊断的概念来源于医学，医生通过询问、观察病人，或者通过仪器检测，利用数据对病症做出判断，而车辆诊断的目的也有类似的地方，为了能够快速准确的判断车辆或者某个控制器的故障以及故障原因，从而为维修提供可靠的依据，内容大致分为三个部分，首先介绍诊断的基本概念，再为大家讲解UDS诊断协议，以及协议中常用到的诊断服务，最后对今天的内容做一个小结。

# 2 诊断的基本概念

车辆的诊断需要有Tester端和ECU端，Tester端和ECU端通过一问一答的形式进行通信，因而Tester端和ECU端都需要遵循同样的诊断通信协议，常用的诊断协议有ISO 14230，ISO 15031，ISO 15765，还有我们熟悉的ISO 14229就是UDS协议，在协议里面定义了诊断的请求，诊断响应的报文格式，以及ECU怎样处理诊断请求报文，以及诊断服务的应用。

![[Pasted image 20240122103018.png]]

UDS是Unified Diagnostic Services的缩写，在国际标准ISO 14229-1中定义，UDS标准中除了定义服务的用法，以及服务的格式以外，还定义了一些标准化的数据，而到OEM要使用UDS协议时，除了要使用标准定义的服务以及标准数据以外，还要依据自身的情况，定义属于OEM的特定数据，比如说，定义所要遵循的服务，需要支持的DID，需要支持的DTC等这些内容，这样形成的符合某OEM的诊断规范才能用于ECU诊断功能的开发以及验证。



UDS的寻址模式分两种，一种是**物理寻址**（**点对点、一对一**），根据物理地址的不同进行访问，但只能访问单个ECU节点，Tester为SA源地址，ECU作为TA目标地址；对应的，另一种是**功能寻址**（**广播、一对多**），根据功能的不同进行访问，它能访问多个ECU节点，对于标准帧来说，通常是0x7DF。

**每一个ECU都有2个CAN的诊断帧ID，分别对应物理寻址的收与发**。通常由主机厂来确定不同ECU的这两个特定的诊断ID。比如0x701对应接收Tester的消息，0x709对应发给Tester的消息。



![[Pasted image 20240122110212.png]]



## 10诊断会话
$10包含3个子功能，01 Default默认会话，02 Programming编程会话，03 Extended扩展会话，ECU上电时，进入的是**默认会话（Default）**。

为什么设计三个会话模式呢？因为权限问题。默认会话权限最小，可操作的服务少；扩展模式通常用于解锁高权限诊断服务，例如写入数据/参数、读写诊断码；编程模式用于解锁bootloader相关的诊断服务，即程序烧录。

![[Pasted image 20240122110519.png]]

如果您进入了一个**非默认会话**的状态，一个定时器会运转，如果一段时间内没有请求，那么到时间后，**诊断退回**到默认会话01(最低权限)。当然，我们有一个**3E**的服务，可以使诊断保持在非默认的状态

UDS的请求命令有4种构成方式，即SID，SID+SF（Sub-function），SID+DID（Data Identifier）（读写用），SID+SF+DID。每种服务都有自己不同的构成方式，查看服务说明即可，不用死记硬背。


NRC：Negative Response Code（否定响应码）。如果ECU拒绝了一个请求，做出否定响应（Negative Response），它会在第三字节回复一个NRC。不同的NRC有不同的含义。本文开头时有一个常见NRC的图，当然完整版请参照ISO14229附录A。
![[Pasted image 20240122110752.png]]
这里提一下一个特殊的NRC——0x78，requestCorrectlyReceived-ResponsePending（RCRRP，**请求已被正确接收-回复待定**）。这个NRC表明请求消息被正确地接收，请求消息中的所有参数都是有效的，但是要执行的操作还没有完成，Server端还没有准备好接收另一个请求。一旦请求的服务已经完成，服务器应该发送一个积极的响应或消极的响应，响应代码应与此不同。这个NRC的消极响应可以被Server端重复，直到被请求的服务完成并且最终的响应消息被发送。


